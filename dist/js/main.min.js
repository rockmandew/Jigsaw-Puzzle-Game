var loaders=[],imgpath="static/img/",imageloadprogress=0,imageloadtotal=0,allimages=[{name:"pictures",images:["city.jpg"],dir:""}];function loadFile(e,a,n){var t=new Deferred,c=new Image;return c.onload=function(){a[n]=c,t.resolve(),imageloadprogress++},c.src=e,t.promise()}function callAllPreloads(e,a){for(var n=0;n<e.length;n++)loaders.push(loadFile(a+e[n],e,n))}for(var im=0;im<allimages.length;im++)imageloadtotal+=allimages[im].images.length,callAllPreloads(allimages[im].images,imgpath+allimages[im].dir+"/");function NewPiece(e,a,n,t,c,i,s,o,l,r){this.x=e,this.y=a,this.w=n,this.h=t,this.solvedx=c,this.solvedy=i,this.spritex=s,this.spritey=o,this.visible=1,this.solved=0,this.offsetx=-1,this.offsety=-1,this.rowx=l,this.rowy=r}!function(e,a){var n={canvas:0,ctx:0,canvasw:0,canvash:0,canvasTopLeft:0,canvasTopRight:0,canvasBottomLeft:0,canvasBottomRight:0,savedcanvasw:0,savedcanvash:0,idealw:1,idealh:1,canvasmode:1,piececountx:6,piececounty:3,puzzle:0,pieces:[],solvedpieces:[],clickedpiece:-1,debug:0,general:{init:function(){n.canvas=document.getElementById("canvas"),n.canvas.getContext?(n.ctx=n.canvas.getContext("2d"),n.general.initPuzzle(),this.setupEvents(),setInterval(n.general.drawPieces,10)):document.getElementById("canvas").innerHTML="Your browser does not support canvas. Sorry."},initPuzzle:function(){n.puzzle=allimages[0].images[0],n.idealw=n.puzzle.width,n.idealh=n.puzzle.height,n.general.initCanvasSize(),n.savedcanvasw=n.canvasw,n.savedcanvash=n.canvash,n.piececountx=6,n.piececounty=3,document.getElementById("piecesx").value=n.piececountx,document.getElementById("piecesy").value=n.piececounty,n.general.createPieces()},initCanvasSize:function(){var e=document.getElementById("canvasparent"),a=e.offsetWidth,t=e.offsetHeight,c=n.general.calculateAspectRatio(n.idealw,n.idealh,a,t);n.canvas.width=n.canvasw=c[0],n.canvas.height=n.canvash=c[1]},calculateAspectRatio:function(e,a,n,t){var c=Math.floor(t/a*e),i=(Math.min(e,n),Math.min(a,t),Math.min(n,c));return[i,i/e*a]},calculatePercentage:function(e,a){return 100/a*e},clearCanvas:function(){n.canvas.width=n.canvas.width},resizeCanvas:function(){n.general.initCanvasSize();for(var e=n.canvasw/n.savedcanvasw*100,a=n.canvash/n.savedcanvash*100,t=0;t<n.pieces.length;t++)n.pieces[t].x=n.pieces[t].x/100*e,n.pieces[t].y=n.pieces[t].y/100*a,n.pieces[t].w=n.pieces[t].w/100*e,n.pieces[t].h=n.pieces[t].h/100*a,n.pieces[t].solvedx=n.pieces[t].solvedx/100*e,n.pieces[t].solvedy=n.pieces[t].solvedy/100*a;for(t=0;t<n.solvedpieces.length;t++)n.solvedpieces[t].x=n.solvedpieces[t].x/100*e,n.solvedpieces[t].y=n.solvedpieces[t].y/100*a,n.solvedpieces[t].w=n.solvedpieces[t].w/100*e,n.solvedpieces[t].h=n.solvedpieces[t].h/100*a,n.solvedpieces[t].solvedx=n.solvedpieces[t].solvedx/100*e,n.solvedpieces[t].solvedy=n.solvedpieces[t].solvedy/100*a;n.savedcanvasw=n.canvasw,n.savedcanvash=n.canvash},resetPuzzle:function(){document.getElementById("options").className="optionswrapper",document.getElementById("body").className="",n.general.initPuzzle()},randomNumber:function(e,a){return Math.random()*(a-e)+e},setupEvents:function(){var e=null!==document.ontouchstart?"mousedown":"touchstart";n.canvas.addEventListener(e,(function(e){var a=n.general.clickDown(e);n.general.clickPiece(a[0],a[1])}),!1);var a=null!==document.ontouchstart?"mouseup":"touchend";n.canvas.addEventListener(a,(function(e){n.general.releasePiece()}),!1);var t=null!==document.ontouchstart?"mousemove":"touchmove";n.canvas.addEventListener(t,(function(e){-1!==n.clickedpiece&&n.general.movePiece(e)}),!1);var c=null!==document.ontouchstart?"mousedown":"touchstart";document.getElementById("updatePuzzle").addEventListener(c,(function(e){n.general.updateSettings()}),!1);var i=null!==document.ontouchstart?"mousedown":"touchstart";document.getElementById("showoptions").addEventListener(i,(function(e){document.getElementById("options").className="optionswrapper shown"}),!1);var s=null!==document.ontouchstart?"mousedown":"touchstart";document.getElementById("hideoptions").addEventListener(s,(function(e){document.getElementById("options").className="optionswrapper"}),!1);var o=null!==document.ontouchstart?"mousedown":"touchstart";document.getElementById("resetPuzzle").addEventListener(o,(function(e){n.general.resetPuzzle()}),!1)},clickDown:function(e){var a=n.canvas.getBoundingClientRect(),t=e.clientX-a.left,c=e.clientY-a.top;return void 0!==e.changedTouches&&(t=e.changedTouches[0].pageX-a.left,c=e.changedTouches[0].pageY-a.top),[t,c]},clickPiece:function(e,a){for(var t=n.pieces.length-1;t>=0;t--)if(n.general.checkCollision(n.pieces[t],e,a)){n.clickedpiece=t,n.general.hideAllPieces(),n.pieces[t].visible=1,n.pieces[t].offsetx=e-n.pieces[t].x,n.pieces[t].offsety=a-n.pieces[t].y;break}},releasePiece:function(){if(-1!==n.clickedpiece){for(var e=0;e<n.pieces.length;e++)n.pieces[e].visible=1;if(n.pieces[n.clickedpiece].offsetx=0,n.pieces[n.clickedpiece].offsety=0,!n.general.checkSolved(n.pieces[n.clickedpiece])){var a=n.pieces[n.clickedpiece];n.pieces.splice(n.clickedpiece,1),n.pieces.push(a)}n.clickedpiece=-1,0===n.pieces.length&&(document.getElementById("body").className="solved")}},movePiece:function(e){var a=n.general.clickDown(e),t=n.pieces[n.clickedpiece],c=a[0]-t.offsetx,i=a[1]-t.offsety,s=Math.min(Math.max(0,c),n.canvasw-t.w),o=Math.min(Math.max(0,i),n.canvash-t.h);t.x=s,t.y=o},checkSolved:function(e){var a=0,t=e.x,c=e.y,i=e.solvedx,s=e.solvedy;if(Math.abs(t-i)<=20&&Math.abs(c-s)<=20){a=1,e.x=i,e.y=s,e.solved=1;var o=e;n.pieces.splice(n.clickedpiece,1),n.solvedpieces.push(o)}return a},checkCollision:function(e,a,n){return e.solved||n>e.y+e.h||n<e.y||a>e.x+e.w||a<e.x?0:1},updateSettings:function(){var e=document.getElementById("piecesx"),a=document.getElementById("piecesy"),t=Math.min(20,e.value),c=Math.min(20,a.value),i=document.getElementById("fileupload").files[0];if(void 0!==i){var s=new FileReader;s.onload=function(){var e=new Image;e.src=s.result,e.onload=function(){n.puzzle=e,n.piececountx=t,n.piececounty=c,n.idealw=n.puzzle.width,n.idealh=n.puzzle.height,n.general.initCanvasSize(),n.savedcanvasw=n.canvasw,n.savedcanvash=n.canvash,n.general.createPieces()}},s.readAsDataURL(i)}else n.piececountx=t,n.piececounty=c,n.general.createPieces();e.value=t,a.value=c,document.getElementById("body").className="",document.getElementById("options").className="optionswrapper"},hideAllPieces:function(){for(var e=0;e<n.pieces.length;e++)n.pieces[e].visible=0},createPieces:function(){n.pieces=[],n.solvedpieces=[];for(var e=n.canvasw/n.piececountx,a=n.canvash/n.piececounty,t=n.canvasw/100*10,c=(n.canvasw-e)/100*90,i=n.canvash/100*10,s=(n.canvash-a)/100*90,o=0;o<n.piececounty;o++)for(var l=0;l<n.piececountx;l++){var r=n.general.randomNumber(t,c),d=n.general.randomNumber(i,s);n.debug&&(r=e*l,d=a*o);var v=new NewPiece(r,d,e,a,e*l,a*o,0,0,l,o);n.pieces.push(v)}},isEven:function(e){return e%2==0},drawPieces:function(){n.general.clearCanvas();for(var e=n.solvedpieces.length,a=0;a<e;a++)n.general.drawPiece(n.solvedpieces[a]);e=n.pieces.length;for(var t=0;t<e;t++)n.general.drawPiece(n.pieces[t])},drawTabOrBlank:function(e,a,t){var c=Math.min(e.h/4,e.w/4),i=0,s=0,o=0,l=0;switch(a){case 0:i=e.x+e.w/2,s=e.y,o=1*Math.PI,l=0*Math.PI;break;case 1:i=e.x+e.w,s=e.y+e.h/2,o=1.5*Math.PI,l=.5*Math.PI;break;case 2:i=e.x+e.w/2,s=e.y+e.h,o=0*Math.PI,l=1*Math.PI;break;case 3:i=e.x,s=e.y+e.h/2,o=.5*Math.PI,l=1.5*Math.PI}n.ctx.arc(i,s,c,o,l,t)},drawPiece:function(e){n.general.isEven(n.piececountx),n.general.isEven(n.piececounty);var a=n.general.isEven(e.rowx),t=n.general.isEven(e.rowy);n.ctx.save(),e.solved?(n.ctx.lineWidth=0,n.ctx.strokeStyle="rgba(0,0,0,0)"):(n.ctx.lineWidth=2,n.ctx.strokeStyle="rgba(0,0,0,0.5)"),e.visible||(n.ctx.globalAlpha=.1),n.ctx.beginPath(),n.ctx.moveTo(e.x,e.y),e.rowy>0&&(t?a?n.general.drawTabOrBlank(e,0,1):n.general.drawTabOrBlank(e,0,0):a?n.general.drawTabOrBlank(e,0,0):n.general.drawTabOrBlank(e,0,1)),n.ctx.lineTo(e.x+e.w,e.y),e.rowx<n.piececountx-1&&(t?a?n.general.drawTabOrBlank(e,1,0):n.general.drawTabOrBlank(e,1,1):a?n.general.drawTabOrBlank(e,1,1):n.general.drawTabOrBlank(e,1,0)),n.ctx.lineTo(e.x+e.w,e.y+e.h),e.rowy<n.piececounty-1&&(t?a?n.general.drawTabOrBlank(e,2,1):n.general.drawTabOrBlank(e,2,0):a?n.general.drawTabOrBlank(e,2,0):n.general.drawTabOrBlank(e,2,1)),n.ctx.lineTo(e.x,e.y+e.h),e.rowx>0&&(t?a?n.general.drawTabOrBlank(e,3,0):n.general.drawTabOrBlank(e,3,1):a?n.general.drawTabOrBlank(e,3,1):n.general.drawTabOrBlank(e,3,0)),n.ctx.lineTo(e.x,e.y),n.ctx.closePath(),n.ctx.clip(),n.ctx.drawImage(n.puzzle,0-e.solvedx+e.x,0-e.solvedy+e.y,n.canvasw,n.canvash),n.ctx.stroke(),n.ctx.restore()}}};e.js=n}(window),window.onload=function(){var e;Deferred.when(loaders).then((function(){js.general.init()})),window.addEventListener("resize",(function(a){clearTimeout(e),e=setTimeout(js.general.resizeCanvas,200)}))};